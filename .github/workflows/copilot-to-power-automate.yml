name: Send Copilot review to Power Automate

on:
  pull_request_review:
    types: [submitted]

jobs:
  send_to_power_automate:
    runs-on: ubuntu-latest

    # 只在 reviewer 是 Copilot 時觸發（第一次可先註解掉，觀察 event payload）
    # if: github.event.review.user.login == 'github-copilot'

    steps:
      - name: Build JSON payload
        id: build
        run: |
          # 這裡先用你的格式，把 Copilot review 內容放進 AIReviewResult
          payload=$(jq -n \
            --arg mr_id "${{ github.event.pull_request.number }}" \
            --arg sys_id "hello-bank" \
            --arg email "happy0520@tcb-bank.com.tw" \
            --arg fullname "Tcb-Boshiun" \
            --arg ai_result "${{ github.event.review.body }}" \
            --arg mr_link "${{ github.event.pull_request.html_url }}" \
            '{
              MergeRequestID: $mr_id,
              SystemID:       $sys_id,
              SubmitterEmail: $email,
              SubmitterFullName: $fullname,
              AIReviewResult: "test",
              MergeRequestLink: $mr_link
            }')

          echo "payload=$payload" >> $GITHUB_OUTPUT

      - name: POST to Power Automate
        env:
          POWER_AUTOMATE_URL: ${{ secrets.POWER_AUTOMATE_URL }}
          POWER_AUTOMATE_API_KEY: ${{ secrets.POWER_AUTOMATE_API_KEY }}
        run: |
          echo "Sending payload to Power Automate..."
          echo '${{ steps.build.outputs.payload }}'

          curl -sS -X POST "$POWER_AUTOMATE_URL" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $POWER_AUTOMATE_API_KEY" \
            -d '${{ steps.build.outputs.payload }}'

